<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>주님의교회 다락방 회계앱</title>
    <style>
        /* 전체 초기화 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #f8f5f2 0%, #f0ede8 100%);
            line-height: 1.5;
            font-size: 16px;
            color: #3a3a3a;
            padding-bottom: 80px;
            min-height: 100vh;
        }

        /* 로그인 화면 */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, #e8d8c8 0%, #d4c4b4 100%);
        }

        .login-form {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px 30px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            text-align: center;
            width: 100%;
            max-width: 400px;
        }

        .login-form h1 {
            color: #6b5b4f;
            margin-bottom: 15px;
            font-size: 20px;
            font-weight: 600;
            line-height: 1.4;
        }

        .login-form p {
            color: #8a7a6e;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .login-form input {
            width: 100%;
            padding: 18px 20px;
            border: 2px solid #d4c4b4;
            border-radius: 12px;
            font-size: 18px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
        }

        .login-form input:focus {
            outline: none;
            border-color: #8a7a6e;
            background: white;
            box-shadow: 0 0 0 3px rgba(138, 122, 110, 0.1);
        }

        .login-form button {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #a69080 0%, #8a7a6e 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 56px;
        }

        .login-form button:hover, .login-form button:active {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(138, 122, 110, 0.3);
        }

        /* 메인 애플리케이션 */
        .main-app {
            display: none;
        }

        /* 헤더 */
        .header {
            background: linear-gradient(135deg, #6b5b4f 0%, #8a7a6e 100%);
            color: white;
            padding: 20px 20px 15px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        /* 컨테이너 */
        .container {
            padding: 20px;
            max-width: 100%;
            margin: 0 auto;
        }

        /* 섹션 */
        .section {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 카드 스타일 */
        .card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(212, 196, 180, 0.3);
        }

        .card h2 {
            color: #6b5b4f;
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }

        .card h3 {
            color: #6b5b4f;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        /* 잔액 요약 카드 */
        .balance-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .balance-card {
            background: linear-gradient(135deg, #a69080 0%, #8a7a6e 100%);
            color: white;
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .balance-card h4 {
            font-size: 14px;
            margin-bottom: 8px;
            opacity: 0.9;
            font-weight: 500;
        }

        .balance-card .amount {
            font-size: 16px;
            font-weight: 700;
            line-height: 1.2;
        }

        /* 폼 그룹 */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #6b5b4f;
            font-size: 16px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #d4c4b4;
            border-radius: 12px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
            min-height: 56px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #8a7a6e;
            background: white;
            box-shadow: 0 0 0 3px rgba(138, 122, 110, 0.1);
        }

        /* 버튼 스타일 */
        .btn {
            width: 100%;
            padding: 18px 20px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            margin-bottom: 12px;
        }

        .btn:last-child {
            margin-bottom: 0;
        }

        .btn-primary {
            background: linear-gradient(135deg, #a69080 0%, #8a7a6e 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #7a8471 0%, #6b7560 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #c4998a 0%, #b5897a 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #d4b5a0 0%, #c4a590 100%);
            color: white;
        }

        .btn:hover, .btn:active {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        /* 거래 내역 스타일 */
        .transaction-list {
            margin-top: 20px;
        }

        .transaction-item {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid #d4c4b4;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .transaction-item.income {
            border-left-color: #7a8471;
        }

        .transaction-item.expense {
            border-left-color: #c4998a;
        }

        .transaction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .transaction-date {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .transaction-type {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 20px;
            font-weight: 600;
        }

        .transaction-type.income {
            background: #e8f1e8;
            color: #5a6b5a;
        }

        .transaction-type.expense {
            background: #f1e8e8;
            color: #6b5a5a;
        }

        .transaction-info {
            margin-bottom: 8px;
        }

        .transaction-category {
            font-weight: 600;
            color: #6b5b4f;
            font-size: 16px;
        }

        .transaction-description {
            color: #666;
            font-size: 14px;
            margin-top: 4px;
        }

        .transaction-amounts {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .transaction-amount {
            font-weight: 700;
            font-size: 16px;
        }

        .transaction-amount.income {
            color: #5a6b5a;
        }

        .transaction-amount.expense {
            color: #6b5a5a;
        }

        .transaction-balance-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .transaction-balance {
            font-size: 14px;
            color: #666;
        }

        .delete-btn {
            background: #c4998a;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            min-height: 36px;
            min-width: 36px;
        }

        /* 알림 */
        .alert {
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.5;
        }

        .alert-warning {
            background: #f5f2f0;
            border: 2px solid #d4c4b4;
            color: #6b5b4f;
        }

        .alert-info {
            background: #f0f8ff;
            border: 2px solid #b3d9ff;
            color: #2c5aa0;
        }

        /* 하단 네비게이션 */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid #e0e0e0;
            padding: 8px 0;
            z-index: 1000;
        }

        .nav-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            max-width: 500px;
            margin: 0 auto;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: #666;
            min-height: 60px;
            justify-content: center;
        }

        .nav-item.active {
            color: #6b5b4f;
            background: rgba(107, 91, 79, 0.1);
            border-radius: 12px;
        }

        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .nav-label {
            font-size: 10px;
            font-weight: 600;
        }

        /* 대시보드 통계 */
        .stats-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .stats-item {
            margin-bottom: 12px;
        }

        .stats-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 4px;
        }

        .stats-value {
            font-size: 16px;
            font-weight: 600;
            color: #6b5b4f;
        }

        /* 보고서 관련 */
        .report-table {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            overflow: hidden;
            margin-top: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .report-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .report-table th,
        .report-table td {
            padding: 12px 10px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }

        .report-table th {
            background: #f8f5f2;
            font-weight: 600;
            color: #6b5b4f;
        }

        /* 보고서 캡처 영역 */
        .report-capture {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* 기간 종료 잔액 금액 크기 조정 */
        .final-balance {
            font-size: 13px !important;
        }

        /* 설정 화면 */
        .settings-current {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .settings-current p {
            margin-bottom: 12px;
            font-size: 14px;
            line-height: 1.6;
        }

        .settings-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .settings-actions .btn {
            flex: 1;
            margin-bottom: 0;
        }

        /* 로그아웃 버튼을 설정 카드 안에 배치 */
        .logout-section {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }

        .logout-section h4 {
            color: #6b5b4f;
            margin-bottom: 10px;
            font-size: 16px;
        }

        /* 보고서 결과 숨김/표시 */
        .report-result {
            display: none;
        }

        .report-result.show {
            display: block;
        }

        /* 반응형 조정 */
        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .balance-grid {
                grid-template-columns: 1fr;
            }
            
            .settings-actions {
                flex-direction: column;
                gap: 12px;
            }
            
            .settings-actions .btn {
                flex: none;
            }

            .nav-grid {
                grid-template-columns: repeat(5, 1fr);
            }

            .nav-icon {
                font-size: 18px;
            }

            .nav-label {
                font-size: 9px;
            }
        }

        /* 접근성 개선 */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* 포커스 가시성 */
        button:focus,
        input:focus,
        select:focus {
            outline: 2px solid #8a7a6e;
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <!-- 로그인 화면 -->
    <div id="loginScreen" class="login-container">
        <div class="login-form">
            <h1>주님의교회<br>다락방 회계앱</h1>
            <p>비밀번호를 입력해주세요</p>
            <input type="password" id="passwordInput" placeholder="비밀번호 입력" onkeypress="checkEnterKey(event)">
            <button onclick="login()">로그인</button>
            <p style="font-size: 14px; color: #999; margin-top: 20px;">
                기본 비밀번호: 1234
            </p>
        </div>
    </div>

    <!-- 메인 애플리케이션 -->
    <div id="mainApp" class="main-app">
        <!-- 헤더 -->
        <div class="header">
            <h1><span id="headerDarakbangName">다락방</span> 회계앱</h1>
            <p>함께 지어져가는 주님의교회</p>
        </div>

        <div class="container">
            <!-- 초기설정 -->
            <div id="setup" class="section active">
                <div class="card">
                    <h2>초기 설정</h2>
                    <div class="alert alert-warning">
                        <strong>중요!</strong> 회계 시작 전에 기본 정보를 설정해주세요.
                    </div>

                    <div id="setupForm">
                        <div class="form-group">
                            <label>다락방 이름</label>
                            <input type="text" id="setupDarakbangName" placeholder="다락방 이름 입력">
                        </div>
                        <div class="form-group">
                            <label>회계 시작일</label>
                            <input type="date" id="setupBaseDate">
                        </div>
                        <div class="form-group">
                            <label>이월 잔고 (원)</label>
                            <input type="number" id="carryOverInput" placeholder="50000" value="50000">
                        </div>
                        <div class="form-group">
                            <label>담당자 이름</label>
                            <input type="text" id="managerName" placeholder="담당자 이름 입력">
                        </div>
                        <div class="form-group">
                            <label>비밀번호 변경 (선택)</label>
                            <input type="password" id="newPassword" placeholder="새 비밀번호 (기본: 1234)">
                        </div>
                        <button onclick="saveInitialSettings()" class="btn btn-success">설정 저장</button>
                    </div>

                    <div id="currentSettings" class="settings-current" style="display: none;">
                        <h3>현재 설정</h3>
                        <p><strong>다락방:</strong> <span id="currentDarakbangName">-</span></p>
                        <p><strong>시작일:</strong> <span id="currentBaseDate">-</span></p>
                        <p><strong>이월잔고:</strong> <span id="currentCarryOver">-</span></p>
                        <p><strong>담당자:</strong> <span id="currentManager">-</span></p>

                        <div class="alert alert-warning" style="margin-top: 20px;">
                            <strong>주의!</strong> 초기화하면 모든 데이터가 삭제됩니다.
                        </div>

                        <div class="settings-actions">
                            <button onclick="editSettings()" class="btn btn-warning">설정 수정</button>
                            <button onclick="resetAllData()" class="btn btn-danger">전체 초기화</button>
                        </div>
                    </div>
                </div>

                <!-- 로그아웃 섹션을 설정 페이지에 배치 -->
                <div class="logout-section">
                    <h4>계정 관리</h4>
                    <button onclick="logout()" class="btn btn-warning">로그아웃</button>
                </div>
            </div>

            <!-- 대시보드 -->
            <div id="dashboard" class="section">
                <div class="balance-grid">
                    <div class="balance-card">
                        <h4>이월 잔고</h4>
                        <div class="amount" id="carryOverBalance">0원</div>
                    </div>
                    <div class="balance-card">
                        <h4>현재 잔액</h4>
                        <div class="amount" id="currentBalance">0원</div>
                    </div>
                    <div class="balance-card">
                        <h4>총 입금</h4>
                        <div class="amount" id="totalIncome">0원</div>
                    </div>
                    <div class="balance-card">
                        <h4>총 출금</h4>
                        <div class="amount" id="totalExpense">0원</div>
                    </div>
                </div>

                <div class="stats-card">
                    <div class="stats-item">
                        <div class="stats-label">다락방 이름</div>
                        <div class="stats-value" id="dashboardDarakbangName">-</div>
                    </div>
                    <div class="stats-item">
                        <div class="stats-label">거래 건수</div>
                        <div class="stats-value" id="transactionCount">0건</div>
                    </div>
                    <div class="stats-item">
                        <div class="stats-label">최근 거래일</div>
                        <div class="stats-value" id="lastTransactionDate">-</div>
                    </div>
                </div>
            </div>

            <!-- 입출금 등록 -->
            <div id="transaction" class="section">
                <div class="card">
                    <h2>입금 등록</h2>
                    <div class="form-group">
                        <label>날짜</label>
                        <input type="date" id="incomeDate">
                    </div>
                    <div class="form-group">
                        <label>입금액</label>
                        <input type="number" id="incomeAmount" placeholder="금액 입력">
                    </div>
                    <div class="form-group">
                        <label>입금 내역</label>
                        <select id="incomeCategory">
                            <option value="다락방 헌금">다락방 헌금</option>
                            <option value="모임비">모임비</option>
                            <option value="후원금">후원금</option>
                            <option value="이자수입">이자수입</option>
                            <option value="기타수입">기타수입</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>상세 내용</label>
                        <input type="text" id="incomeDescription" placeholder="상세 내용 (선택)">
                    </div>
                    <button onclick="addTransaction('income')" class="btn btn-success">입금 등록</button>
                </div>

                <div class="card">
                    <h2>출금 등록</h2>
                    <div class="form-group">
                        <label>날짜</label>
                        <input type="date" id="expenseDate">
                    </div>
                    <div class="form-group">
                        <label>출금액</label>
                        <input type="number" id="expenseAmount" placeholder="금액 입력">
                    </div>
                    <div class="form-group">
                        <label>출금 내역</label>
                        <select id="expenseCategory">
                            <option value="다락방 헌금">다락방 헌금</option>
                            <option value="식사비">식사비</option>
                            <option value="열린 다락방 모임비">열린 다락방 모임비</option>
                            <option value="선물비">선물비</option>
                            <option value="행사비">행사비</option>
                            <option value="기타지출">기타지출</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>상세 내용</label>
                        <input type="text" id="expenseDescription" placeholder="상세 내용 (선택)">
                    </div>
                    <button onclick="addTransaction('expense')" class="btn btn-danger">출금 등록</button>
                </div>
            </div>

            <!-- 거래 내역 -->
            <div id="history" class="section">
                <div class="card">
                    <h2>거래 내역</h2>
                    <div class="transaction-list" id="transactionHistory">
                        <!-- 거래 내역이 여기에 동적으로 생성됩니다 -->
                    </div>
                </div>
            </div>

            <!-- 보고서 -->
            <div id="report" class="section">
                <div class="card">
                    <h2>회계 보고서</h2>
                    
                    <div class="alert alert-info">
                        <strong>안내:</strong> 기간을 선택하고 보고서 생성 버튼을 눌러주세요. 기간을 선택하지 않으면 전체 기간 보고서가 생성됩니다.
                    </div>
                    
                    <div class="form-group">
                        <label>시작 날짜</label>
                        <input type="date" id="reportStartDate">
                    </div>
                    <div class="form-group">
                        <label>종료 날짜</label>
                        <input type="date" id="reportEndDate">
                    </div>
                    <button onclick="generateReport()" class="btn btn-primary">보고서 생성</button>
                </div>

                <!-- 보고서 결과 영역 -->
                <div class="report-result" id="reportResult">
                    <!-- 보고서 캡처 영역 -->
                    <div class="report-capture" id="reportCapture">
                        <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 20px;">
                            <h3 style="color: #6b5b4f; margin-bottom: 10px;">회계 보고서</h3>
                            <p><strong>다락방:</strong> <span id="reportDarakbangName">-</span></p>
                            <p><strong>보고서 기간:</strong> <span id="reportPeriod">전체</span></p>
                            <p><strong>담당자:</strong> <span id="reportManager">-</span></p>
                            <p><strong>작성일:</strong> <span id="reportDate">-</span></p>
                        </div>

                        <div class="report-table">
                            <table id="consolidatedReport">
                                <thead>
                                    <tr>
                                        <th>항목</th>
                                        <th style="text-align: right;">금액</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card">
                        <button onclick="captureReport()" class="btn btn-success">보고서 이미지로 저장</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 하단 네비게이션 -->
        <div class="bottom-nav">
            <div class="nav-grid">
                <div class="nav-item active" onclick="showSection('setup')">
                    <div class="nav-icon">⚙️</div>
                    <div class="nav-label">설정</div>
                </div>
                <div class="nav-item" onclick="showSection('dashboard')">
                    <div class="nav-icon">📊</div>
                    <div class="nav-label">대시보드</div>
                </div>
                <div class="nav-item" onclick="showSection('transaction')">
                    <div class="nav-icon">💰</div>
                    <div class="nav-label">입출금</div>
                </div>
                <div class="nav-item" onclick="showSection('history')">
                    <div class="nav-icon">📋</div>
                    <div class="nav-label">내역</div>
                </div>
                <div class="nav-item" onclick="showSection('report')">
                    <div class="nav-icon">📄</div>
                    <div class="nav-label">보고서</div>
                </div>
            </div>
        </div>
    </div>

    <!-- HTML2Canvas 라이브러리 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        // 전역 변수
        let transactions = [];
        let currentPassword = '1234';
        let settings = {
            darakbangName: '',
            baseDate: '',
            carryOverBalance: 0,
            managerName: '',
            isSetup: false
        };

        // 데이터 저장/로드
        function saveData() {
            try {
                const data = {
                    transactions: transactions,
                    settings: settings,
                    currentPassword: currentPassword,
                    lastSaved: new Date().toISOString()
                };
                localStorage.setItem('darakbang-accounting-data', JSON.stringify(data));
            } catch (error) {
                console.error('데이터 저장 오류:', error);
            }
        }

        function loadData() {
            try {
                const savedData = localStorage.getItem('darakbang-accounting-data');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    transactions = data.transactions || [];
                    settings = data.settings || {
                        darakbangName: '',
                        baseDate: '',
                        carryOverBalance: 0,
                        managerName: '',
                        isSetup: false
                    };
                    currentPassword = data.currentPassword || '1234';
                    return true;
                }
            } catch (error) {
                console.error('데이터 로드 오류:', error);
            }
            return false;
        }

        // 로그인/로그아웃
        function checkEnterKey(event) {
            if (event.key === 'Enter') {
                login();
            }
        }

        function login() {
            const password = document.getElementById('passwordInput').value;
            if (password === currentPassword) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                loadSettings();
                setTodayAsDefault();
                updateAllDisplays();
                updateHeaderDarakbangName();
                // 로그인 시에는 보고서를 자동 생성하지 않음
            } else {
                showAlert('비밀번호가 올바르지 않습니다.');
                document.getElementById('passwordInput').value = '';
            }
        }

        function logout() {
            if (confirm('로그아웃 하시겠습니까?')) {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('passwordInput').value = '';
            }
        }

        // 초기화
        window.onload = function() {
            loadData();
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        };

        function setTodayAsDefault() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('setupBaseDate').value = today;
            document.getElementById('incomeDate').value = today;
            document.getElementById('expenseDate').value = today;
        }

        // 설정 관련
        function updateHeaderDarakbangName() {
            const headerElement = document.getElementById('headerDarakbangName');
            if (settings.darakbangName) {
                headerElement.textContent = `${settings.darakbangName} 다락방`;
            } else {
                headerElement.textContent = '다락방';
            }
        }

        function saveInitialSettings() {
            const darakbangName = document.getElementById('setupDarakbangName').value.trim();
            const baseDate = document.getElementById('setupBaseDate').value;
            const carryOver = parseInt(document.getElementById('carryOverInput').value) || 0;
            const manager = document.getElementById('managerName').value.trim();
            const newPassword = document.getElementById('newPassword').value.trim();

            if (!darakbangName) {
                showAlert('다락방 이름을 입력해주세요.');
                return;
            }
            if (!baseDate) {
                showAlert('회계 시작일을 선택해주세요.');
                return;
            }
            if (!manager) {
                showAlert('담당자 이름을 입력해주세요.');
                return;
            }

            settings = {
                darakbangName: darakbangName,
                baseDate: baseDate,
                carryOverBalance: carryOver,
                managerName: manager,
                isSetup: true
            };

            if (newPassword) {
                currentPassword = newPassword;
            }

            updateSettingsDisplay();
            updateAllDisplays();
            updateHeaderDarakbangName();
            saveData();
            showAlert('설정이 저장되었습니다!');
            document.getElementById('newPassword').value = '';
        }

        function updateSettingsDisplay() {
            if (settings.isSetup) {
                document.getElementById('setupForm').style.display = 'none';
                document.getElementById('currentSettings').style.display = 'block';
                document.getElementById('currentDarakbangName').textContent = settings.darakbangName;
                document.getElementById('currentBaseDate').textContent = settings.baseDate;
                document.getElementById('currentCarryOver').textContent = settings.carryOverBalance.toLocaleString() + '원';
                document.getElementById('currentManager').textContent = settings.managerName;
            } else {
                document.getElementById('setupForm').style.display = 'block';
                document.getElementById('currentSettings').style.display = 'none';
            }
        }

        function editSettings() {
            if (confirm('설정을 수정하시겠습니까?')) {
                document.getElementById('setupDarakbangName').value = settings.darakbangName;
                document.getElementById('setupBaseDate').value = settings.baseDate;
                document.getElementById('carryOverInput').value = settings.carryOverBalance;
                document.getElementById('managerName').value = settings.managerName;
                document.getElementById('setupForm').style.display = 'block';
                document.getElementById('currentSettings').style.display = 'none';
            }
        }

        function resetAllData() {
            const confirmText = `모든 데이터를 초기화하시겠습니까?\n\n삭제되는 데이터:\n• 설정 정보\n• 거래 내역 (${transactions.length}건)\n• 비밀번호 초기화`;
            
            if (confirm(confirmText)) {
                const finalConfirm = prompt('정말로 초기화하려면 "초기화"를 입력하세요:', '');
                if (finalConfirm === '초기화') {
                    transactions = [];
                    currentPassword = '1234';
                    settings = {
                        darakbangName: '',
                        baseDate: '',
                        carryOverBalance: 0,
                        managerName: '',
                        isSetup: false
                    };
                    
                    document.getElementById('setupDarakbangName').value = '';
                    document.getElementById('setupBaseDate').value = '';
                    document.getElementById('carryOverInput').value = '50000';
                    document.getElementById('managerName').value = '';
                    document.getElementById('newPassword').value = '';
                    
                    document.getElementById('setupForm').style.display = 'block';
                    document.getElementById('currentSettings').style.display = 'none';
                    
                    // 보고서 결과 숨기기
                    document.getElementById('reportResult').classList.remove('show');
                    
                    setTodayAsDefault();
                    updateAllDisplays();
                    updateHeaderDarakbangName();
                    saveData();
                    showAlert('모든 데이터가 초기화되었습니다.');
                }
            }
        }

        function loadSettings() {
            updateSettingsDisplay();
        }

        // 섹션 전환 (수정됨: 보고서 자동 생성 제거)
        function showSection(sectionName) {
            if (!settings.isSetup && sectionName !== 'setup') {
                showAlert('먼저 초기 설정을 완료해주세요.');
                return;
            }

            // 모든 섹션 숨기기
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => section.classList.remove('active'));

            // 모든 네비게이션 버튼 비활성화
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));

            // 선택된 섹션 표시
            document.getElementById(sectionName).classList.add('active');
            
            // 해당 네비게이션 버튼 활성화
            const activeNavItem = Array.from(navItems).find(item => 
                item.onclick.toString().includes(`showSection('${sectionName}')`)
            );
            if (activeNavItem) {
                activeNavItem.classList.add('active');
            }

            // 보고서 섹션일 때 보고서 결과 숨기기
            if (sectionName === 'report') {
                document.getElementById('reportResult').classList.remove('show');
            }
        }

        // 거래 등록
        function addTransaction(type) {
            if (!settings.isSetup) {
                showAlert('먼저 초기 설정을 완료해주세요.');
                return;
            }

            let amount, category, description, date;

            if (type === 'income') {
                date = document.getElementById('incomeDate').value;
                amount = parseInt(document.getElementById('incomeAmount').value);
                category = document.getElementById('incomeCategory').value;
                description = document.getElementById('incomeDescription').value;

                if (!date) {
                    showAlert('날짜를 선택해주세요.');
                    return;
                }
                if (!amount || amount <= 0) {
                    showAlert('올바른 입금액을 입력해주세요.');
                    return;
                }

                document.getElementById('incomeAmount').value = '';
                document.getElementById('incomeDescription').value = '';
            } else {
                date = document.getElementById('expenseDate').value;
                amount = parseInt(document.getElementById('expenseAmount').value);
                category = document.getElementById('expenseCategory').value;
                description = document.getElementById('expenseDescription').value;

                if (!date) {
                    showAlert('날짜를 선택해주세요.');
                    return;
                }
                if (!amount || amount <= 0) {
                    showAlert('올바른 출금액을 입력해주세요.');
                    return;
                }

                document.getElementById('expenseAmount').value = '';
                document.getElementById('expenseDescription').value = '';
            }

            const currentBalance = getCurrentBalance();
            const newBalance = type === 'income' ? currentBalance + amount : currentBalance - amount;

            const transaction = {
                id: Date.now(),
                dateTime: new Date().toLocaleString('ko-KR', {
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
                }),
                date: date,
                type: type,
                category: category,
                description: description || '',
                amount: amount,
                balance: newBalance
            };

            transactions.push(transaction);
            updateAllDisplays();
            saveData();
            showAlert(type === 'income' ? '입금이 등록되었습니다!' : '출금이 등록되었습니다!');
        }

        // 거래 삭제
        function deleteTransaction(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (transaction && confirm(`${transaction.category} 거래(${transaction.amount.toLocaleString()}원)를 삭제하시겠습니까?`)) {
                const index = transactions.findIndex(t => t.id === transactionId);
                transactions.splice(index, 1);
                recalculateBalances();
                updateAllDisplays();
                saveData();
                showAlert('거래가 삭제되었습니다.');
            }
        }

        // 잔액 재계산
        function recalculateBalances() {
            let currentBalance = settings.carryOverBalance;
            transactions.sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));
            
            transactions.forEach(transaction => {
                if (transaction.type === 'income') {
                    currentBalance += transaction.amount;
                } else {
                    currentBalance -= transaction.amount;
                }
                transaction.balance = currentBalance;
            });
        }

        function getCurrentBalance() {
            let balance = settings.carryOverBalance;
            transactions.forEach(transaction => {
                if (transaction.type === 'income') {
                    balance += transaction.amount;
                } else {
                    balance -= transaction.amount;
                }
            });
            return balance;
        }

        // 화면 업데이트
        function updateAllDisplays() {
            updateDashboard();
            updateTransactionHistory();
        }

        function updateDashboard() {
            const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const currentBalance = getCurrentBalance();

            document.getElementById('carryOverBalance').textContent = settings.carryOverBalance.toLocaleString() + '원';
            document.getElementById('totalIncome').textContent = totalIncome.toLocaleString() + '원';
            document.getElementById('totalExpense').textContent = totalExpense.toLocaleString() + '원';
            document.getElementById('currentBalance').textContent = currentBalance.toLocaleString() + '원';
            document.getElementById('transactionCount').textContent = transactions.length + '건';

            if (transactions.length > 0) {
                document.getElementById('lastTransactionDate').textContent = new Date(transactions[transactions.length - 1].date).toLocaleDateString('ko-KR');
            } else {
                document.getElementById('lastTransactionDate').textContent = '-';
            }

            document.getElementById('dashboardDarakbangName').textContent = settings.darakbangName || '-';
        }

        function updateTransactionHistory() {
            const container = document.getElementById('transactionHistory');
            let allTransactions = [...transactions];

            if (allTransactions.length === 0 && !settings.isSetup) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">등록된 거래 내역이 없습니다.</p>';
                return;
            }

            container.innerHTML = '';

            // 이월 잔고 항목을 먼저 추가 (맨 위에)
            if (settings.isSetup) {
                const carryOverItem = document.createElement('div');
                carryOverItem.className = 'transaction-item';
                carryOverItem.innerHTML = `
                    <div class="transaction-header">
                        <div class="transaction-date">${settings.baseDate || '-'}</div>
                        <div class="transaction-type">이월</div>
                    </div>
                    <div class="transaction-info">
                        <div class="transaction-category">이월 잔고</div>
                    </div>
                    <div class="transaction-amounts">
                        <div class="transaction-amount income">+${settings.carryOverBalance.toLocaleString()}원</div>
                        <div class="transaction-balance">잔액: ${settings.carryOverBalance.toLocaleString()}원</div>
                    </div>
                `;
                container.appendChild(carryOverItem);
            }

            // 시간순 정렬 (오래된 순서부터 = 최신이 아래로)
            allTransactions.sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));

            allTransactions.forEach(transaction => {
                const item = document.createElement('div');
                item.className = `transaction-item ${transaction.type}`;
                
                item.innerHTML = `
                    <div class="transaction-header">
                        <div class="transaction-date">${transaction.date}</div>
                        <div class="transaction-type ${transaction.type}">
                            ${transaction.type === 'income' ? '입금' : '출금'}
                        </div>
                    </div>
                    <div class="transaction-info">
                        <div class="transaction-category">${transaction.category}</div>
                        ${transaction.description ? `<div class="transaction-description">${transaction.description}</div>` : ''}
                    </div>
                    <div class="transaction-amounts">
                        <div class="transaction-amount ${transaction.type}">
                            ${transaction.type === 'income' ? '+' : '-'}${transaction.amount.toLocaleString()}원
                        </div>
                        <div class="transaction-balance-row">
                            <div class="transaction-balance">잔액: ${transaction.balance.toLocaleString()}원</div>
                            <button class="delete-btn" onclick="deleteTransaction(${transaction.id})">삭제</button>
                        </div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        // 보고서 생성 (수정됨: 버튼 클릭 시에만 실행)
        function generateReport() {
            if (!settings.isSetup) {
                showAlert('먼저 초기 설정을 완료해주세요.');
                return;
            }

            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;

            let filteredTransactions = transactions;

            // 날짜 필터링 로직 수정
            if (startDate && endDate) {
                filteredTransactions = transactions.filter(transaction => {
                    const transactionDate = transaction.date;
                    return transactionDate >= startDate && transactionDate <= endDate;
                });
            } else if (startDate) {
                filteredTransactions = transactions.filter(transaction => {
                    return transaction.date >= startDate;
                });
            } else if (endDate) {
                filteredTransactions = transactions.filter(transaction => {
                    return transaction.date <= endDate;
                });
            }

            let periodStartBalance = settings.carryOverBalance;
            if (startDate) {
                const beforeStartTransactions = transactions.filter(transaction => {
                    return transaction.date < startDate;
                });
                beforeStartTransactions.forEach(transaction => {
                    if (transaction.type === 'income') {
                        periodStartBalance += transaction.amount;
                    } else {
                        periodStartBalance -= transaction.amount;
                    }
                });
            }

            const totalIncomeInPeriod = filteredTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpenseInPeriod = filteredTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const periodEndBalance = periodStartBalance + totalIncomeInPeriod - totalExpenseInPeriod;

            // 카테고리별 집계 - 모든 카테고리 표시
            const incomeByCategory = {
                '다락방 헌금': 0, '모임비': 0, '후원금': 0, '이자수입': 0, '기타수입': 0
            };

            const expenseByCategory = {
                '다락방 헌금': 0, '식사비': 0, '열린 다락방 모임비': 0, '선물비': 0, '행사비': 0, '기타지출': 0
            };

            filteredTransactions.forEach(transaction => {
                if (transaction.type === 'income' && incomeByCategory.hasOwnProperty(transaction.category)) {
                    incomeByCategory[transaction.category] += transaction.amount;
                } else if (transaction.type === 'expense' && expenseByCategory.hasOwnProperty(transaction.category)) {
                    expenseByCategory[transaction.category] += transaction.amount;
                }
            });

            document.getElementById('reportDate').textContent = new Date().toLocaleDateString('ko-KR');
            document.getElementById('reportDarakbangName').textContent = settings.darakbangName || '-';
            document.getElementById('reportManager').textContent = settings.managerName || '-';

            let periodText = '전체';
            if (startDate && endDate) {
                periodText = `${startDate} ~ ${endDate}`;
            } else if (startDate) {
                periodText = `${startDate} 이후`;
            } else if (endDate) {
                periodText = `${endDate} 이전`;
            }
            document.getElementById('reportPeriod').textContent = periodText;

            const tbody = document.querySelector('#consolidatedReport tbody');
            tbody.innerHTML = '';

            // 수입 내역 요약
            tbody.innerHTML += `<tr style="background: #f8f5f2;"><td colspan="2"><strong>수입 내역 요약</strong></td></tr>`;
            tbody.innerHTML += `<tr><td>이월 잔고</td><td style="text-align: right;">${periodStartBalance.toLocaleString()}원</td></tr>`;
            
            // 모든 수입 카테고리 표시 (0원도 표시)
            for (const category in incomeByCategory) {
                tbody.innerHTML += `<tr><td>${category}</td><td style="color: #5a6b5a; font-weight: 600; text-align: right;">${incomeByCategory[category].toLocaleString()}원</td></tr>`;
            }
            tbody.innerHTML += `<tr style="background: #e8f5e8;"><td><strong>총 수입</strong></td><td style="color: #5a6b5a; font-weight: 700; text-align: right;"><strong>${(periodStartBalance + totalIncomeInPeriod).toLocaleString()}원</strong></td></tr>`;

            // 지출 내역 요약
            tbody.innerHTML += `<tr style="background: #f8f5f2;"><td colspan="2"><strong>지출 내역 요약</strong></td></tr>`;
            
            // 모든 지출 카테고리 표시 (0원도 표시)
            for (const category in expenseByCategory) {
                tbody.innerHTML += `<tr><td>${category}</td><td style="color: #6b5a5a; font-weight: 600; text-align: right;">${expenseByCategory[category].toLocaleString()}원</td></tr>`;
            }
            tbody.innerHTML += `<tr style="background: #f5e8e8;"><td><strong>총 지출</strong></td><td style="color: #6b5a5a; font-weight: 700; text-align: right;"><strong>${totalExpenseInPeriod.toLocaleString()}원</strong></td></tr>`;

            // 최종 결산
            tbody.innerHTML += `<tr style="background: #f0f0f0;"><td colspan="2"><strong>최종 결산</strong></td></tr>`;
            tbody.innerHTML += `<tr><td>기간 시작 잔액</td><td style="text-align: right;">${periodStartBalance.toLocaleString()}원</td></tr>`;
            tbody.innerHTML += `<tr><td>총 수입</td><td style="color: #5a6b5a; text-align: right;">+${totalIncomeInPeriod.toLocaleString()}원</td></tr>`;
            tbody.innerHTML += `<tr><td>총 지출</td><td style="color: #6b5a5a; text-align: right;">-${totalExpenseInPeriod.toLocaleString()}원</td></tr>`;
            tbody.innerHTML += `<tr style="background: #e0e0e0; font-weight: 700;"><td><strong>기간 종료 잔액</strong></td><td style="text-align: right;"><strong class="final-balance">${periodEndBalance.toLocaleString()}원</strong></td></tr>`;

            // 보고서 결과 표시
            document.getElementById('reportResult').classList.add('show');
            showAlert('보고서가 생성되었습니다!');
        }

        // 보고서 이미지 캡처 및 저장
        function captureReport() {
            if (!window.html2canvas) {
                showAlert('이미지 저장 기능을 로드하는 중입니다. 잠시 후 다시 시도해주세요.');
                return;
            }

            const captureElement = document.getElementById('reportCapture');
            
            showAlert('보고서를 이미지로 변환 중입니다...');
            
            html2canvas(captureElement, {
                backgroundColor: '#ffffff',
                scale: 2,
                useCORS: true,
                allowTaint: true
            }).then(function(canvas) {
                // 이미지를 다운로드 가능한 링크로 변환
                const link = document.createElement('a');
                link.download = `다락방_회계보고서_${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL();
                
                // 자동 다운로드 실행
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showAlert('보고서 이미지가 저장되었습니다!');
            }).catch(function(error) {
                console.error('이미지 저장 오류:', error);
                showAlert('이미지 저장 중 오류가 발생했습니다.');
            });
        }

        // 알림 표시
        function showAlert(message) {
            alert(message);
        }
    </script>
</body>
</html>
